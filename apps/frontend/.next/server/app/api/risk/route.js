"use strict";(()=>{var e={};e.id=926,e.ids=[926],e.modules={5890:e=>{e.exports=require("better-sqlite3")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},6005:e=>{e.exports=require("node:crypto")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},4577:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},7310:e=>{e.exports=require("url")},5206:e=>{e.exports=require("zlib")},1826:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>T,originalPathname:()=>D,patchFetch:()=>A,requestAsyncStorage:()=>L,routeModule:()=>q,serverHooks:()=>I,staticGenerationAsyncStorage:()=>E,staticGenerationBailout:()=>F});var i={};r.r(i),r.d(i,{GET:()=>_,POST:()=>w});var s=r(5489),a=r(8285),o=r(2377),n=r(1225),l=r(9621),c=r(2571),u=r(3973),d=r(7991);function m(){let e=process.env.SUPABASE_URL,t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase configuration is missing. Please set SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY environment variables.");return(0,l.eI)(e,t)}let g=c.z.object({action:c.z.enum(["get_status","trigger_kill_switch","reset_kill_switch","update_limits","acknowledge_alert"]),data:c.z.any().optional()}),p=c.z.object({maxDailyLoss:c.z.number().positive().optional(),maxDrawdown:c.z.number().min(0).max(100).optional(),maxConsecutiveFailures:c.z.number().positive().optional(),maxPortfolioRisk:c.z.number().min(5).max(50).optional(),maxSectorConcentration:c.z.number().min(5).max(100).optional(),maxCorrelation:c.z.number().min(0).max(1).optional()}),f=c.z.object({reason:c.z.string().min(1),severity:c.z.enum(["low","medium","high","critical"]).default("high")}),h=c.z.object({reason:c.z.string().min(1),resetBy:c.z.string().min(1)});async function _(e){try{let t=await u.qQ.checkLimit(e);if(!t.allowed)return n.Z.json({error:"Rate limit exceeded",retryAfter:t.retryAfter},{status:429});let r=await (0,d.PZ)(e);if(!r.success)return n.Z.json({error:"Unauthorized",details:r.error},{status:401});let i=r.payload?.sub,s=await y(i);return n.Z.json({success:!0,data:s,timestamp:new Date().toISOString()})}catch(e){return console.error("Risk API error:",e),n.Z.json({error:"Internal server error"},{status:500})}}async function w(e){try{let t=await u.qQ.checkLimit(e,"action");if(!t.allowed)return n.Z.json({error:"Rate limit exceeded",retryAfter:t.retryAfter},{status:429});let r=await (0,d.PZ)(e);if(!r.success)return n.Z.json({error:"Unauthorized",details:r.error},{status:401});let i=r.payload?.sub,s=await e.json(),a=g.safeParse(s);if(!a.success)return n.Z.json({error:"Invalid request",details:a.error?.errors||[]},{status:400});let{action:o,data:l}=a.data;switch(o){case"get_status":let c=await y(i);return n.Z.json({success:!0,data:c});case"trigger_kill_switch":let m=await x(i,l);return n.Z.json(m);case"reset_kill_switch":let p=await k(i,l);return n.Z.json(p);case"update_limits":let f=await v(i,l);return n.Z.json(f);case"acknowledge_alert":let h=await b(i,l);return n.Z.json(h);default:return n.Z.json({error:"Unknown action"},{status:400})}}catch(e){return console.error("Risk API error:",e),n.Z.json({error:"Internal server error"},{status:500})}}async function y(e){try{let t=m(),{data:r,error:i}=await t.from("bot_configurations").select(`
        id,
        name,
        type,
        status,
        is_active,
        is_paper_trading,
        configuration
      `).eq("user_id",e);if(i)throw console.error("Error fetching bots:",i),Error("Failed to fetch bot data");let s=new Date(Date.now()-864e5).toISOString(),{data:a,error:o}=await t.from("trade_history").select(`
        profit_loss_usd,
        gas_fee_usd,
        status,
        executed_at,
        bot_configurations!inner(user_id)
      `).eq("bot_configurations.user_id",e).gte("executed_at",s);o&&console.error("Error fetching trades:",o);let{data:n,error:l}=await t.from("user_risk_settings").select("*").eq("user_id",e).single();l&&"PGRST116"!==l.code&&console.error("Error fetching risk config:",l);let c=function(e,t){let r=e.filter(e=>"completed"===e.status),i=e.filter(e=>"failed"===e.status),s=r.reduce((e,t)=>e+parseFloat(t.profit_loss_usd||"0"),0),a=s-e.reduce((e,t)=>e+parseFloat(t.gas_fee_usd||"0"),0),o=r.length>0?r.filter(e=>parseFloat(e.profit_loss_usd||"0")>0).length/r.length*100:0,n=e.length>0?i.length/e.length*100:0,l=i.reduce((e,t)=>e+parseFloat(t.gas_fee_usd||"0"),0),c=i.length>0?l/i.length:0,u=a-l,d=Math.abs(Math.min(0,u)),m=function(e){let t=0;for(let r of e.sort((e,t)=>new Date(t.executed_at).getTime()-new Date(e.executed_at).getTime()))if("failed"===r.status)t++;else if("completed"===r.status)break;return t}(e),g=t||S();return{dailyPnL:Math.round(100*a)/100,dailyPnLAdjusted:Math.round(100*u)/100,dailyLoss:Math.round(100*d)/100,totalTrades:e.length,completedTrades:r.length,failedTrades:i.length,winRate:Math.round(100*o)/100,failureRate:Math.round(100*n)/100,failedTradeCosts:Math.round(100*l)/100,avgFailedTradeCost:Math.round(100*c)/100,failureImpact:Math.round(100*(Math.abs(s)>0?l/Math.abs(s)*100:0))/100,consecutiveFailures:m,riskLimits:{maxDailyLoss:g.max_daily_loss||1e3,maxDrawdown:g.max_drawdown||15,maxConsecutiveFailures:g.max_consecutive_failures||5,maxFailureRate:g.max_failure_rate||30},riskUtilization:{dailyLoss:d/(g.max_daily_loss||1e3),consecutiveFailures:m/(g.max_consecutive_failures||5),failureRate:n/(g.max_failure_rate||30)}}}(a||[],n),{data:u,error:d}=await t.from("risk_alerts").select("*").eq("user_id",e).eq("acknowledged",!1).order("created_at",{ascending:!1}).limit(20);d&&console.error("Error fetching alerts:",d);let g=await R(e,c),p=function(e,t,r){let i=[];e.riskUtilization.dailyLoss>.8&&i.push({type:"reduce_risk",priority:"high",title:"Reduce Daily Risk Exposure",description:"Daily losses are approaching the limit. Consider reducing position sizes or stopping some bots.",action:"Consider stopping non-essential bots or reducing trade sizes"}),e.consecutiveFailures>3&&i.push({type:"review_strategy",priority:"medium",title:"Review Trading Strategy",description:"Multiple consecutive failures detected. Strategy may need adjustment.",action:"Review bot configurations and market conditions"}),e.failureRate>25&&i.push({type:"high_failure_rate",priority:"high",title:"High Trade Failure Rate",description:`${e.failureRate.toFixed(1)}% of trades are failing. This may indicate strategy or market issues.`,action:"Review trade execution parameters and market conditions"}),e.failureImpact>10&&i.push({type:"failure_costs",priority:"medium",title:"High Failed Trade Costs",description:`Failed trades are costing ${e.failureImpact.toFixed(1)}% of total trading profit in gas fees.`,action:"Optimize gas fee settings and trade execution timing"}),t.filter(e=>e.is_active).length>5&&i.push({type:"reduce_exposure",priority:"medium",title:"Reduce Active Bots",description:"Multiple active bots increase complexity and risk.",action:"Consider focusing on best-performing bots"});let s=r.filter(e=>"critical"===e.severity&&!e.acknowledged);return s.length>0&&i.push({type:"address_alerts",priority:"critical",title:"Address Critical Alerts",description:`${s.length} critical alerts require immediate attention.`,action:"Review and acknowledge critical risk alerts"}),i}(c,r||[],u||[]);return{portfolioRisk:c,killSwitch:g,activeBots:{total:r?.length||0,active:r?.filter(e=>e.is_active).length||0,paperTrading:r?.filter(e=>e.is_paper_trading).length||0},alerts:u||[],recommendations:p,configuration:n||S(),lastUpdated:new Date().toISOString()}}catch(e){throw console.error("Error getting risk status:",e),e}}async function x(e,t){try{let r=f.safeParse(t);if(!r.success)return{success:!1,error:"Invalid trigger data",details:r.error?.errors||[]};let{reason:i,severity:s}=r.data,a=m(),{data:o,error:n}=await a.from("bot_configurations").select("id, name").eq("user_id",e).eq("is_active",!0);if(n)return console.error("Error fetching active bots:",n),{success:!1,error:"Failed to fetch active bots"};if(o&&o.length>0){let{error:t}=await a.from("bot_configurations").update({is_active:!1,status:"stopped",updated_at:new Date().toISOString()}).eq("user_id",e).eq("is_active",!0);if(t)return console.error("Error stopping bots:",t),{success:!1,error:"Failed to stop bots"}}let{error:l}=await a.from("kill_switch_events").insert({user_id:e,event_type:"triggered",reason:i,severity:s,affected_bots:o?.map(e=>e.id)||[],metadata:{timestamp:new Date().toISOString(),triggeredBy:"user"}});return l&&console.error("Error logging kill switch event:",l),await a.from("risk_alerts").insert({user_id:e,alert_type:"kill_switch",severity:"critical",message:`Kill switch triggered: ${i}`,metadata:{stoppedBots:o?.length||0,severity:s}}),{success:!0,message:"Kill switch triggered successfully",data:{reason:i,severity:s,botsStoppedCount:o?.length||0,stoppedBots:o||[]}}}catch(e){return console.error("Error triggering kill switch:",e),{success:!1,error:"Internal server error"}}}async function k(e,t){try{let r=h.safeParse(t);if(!r.success)return{success:!1,error:"Invalid reset data",details:r.error?.errors||[]};let{reason:i,resetBy:s}=r.data,a=m(),{error:o}=await a.from("kill_switch_events").insert({user_id:e,event_type:"reset",reason:`Reset: ${i}`,severity:"low",metadata:{resetBy:s,timestamp:new Date().toISOString()}});return o&&console.error("Error logging reset event:",o),await a.from("risk_alerts").update({acknowledged:!0}).eq("user_id",e).eq("alert_type","kill_switch"),{success:!0,message:"Kill switch reset successfully",data:{reason:i,resetBy:s,resetAt:new Date().toISOString()}}}catch(e){return console.error("Error resetting kill switch:",e),{success:!1,error:"Internal server error"}}}async function v(e,t){try{let r=p.safeParse(t);if(!r.success)return{success:!1,error:"Invalid limits data",details:r.error?.errors||[]};let i=r.data,s=m(),{data:a,error:o}=await s.from("user_risk_settings").upsert({user_id:e,max_daily_loss:i.maxDailyLoss,max_drawdown:i.maxDrawdown,max_consecutive_failures:i.maxConsecutiveFailures,max_portfolio_risk:i.maxPortfolioRisk,max_sector_concentration:i.maxSectorConcentration,max_correlation:i.maxCorrelation,updated_at:new Date().toISOString()},{onConflict:"user_id"}).select().single();if(o)return console.error("Error updating risk limits:",o),{success:!1,error:"Failed to update risk limits"};return{success:!0,message:"Risk limits updated successfully",data:a}}catch(e){return console.error("Error updating risk limits:",e),{success:!1,error:"Internal server error"}}}async function b(e,t){try{let{alertId:r}=t;if(!r)return{success:!1,error:"Alert ID is required"};let i=m(),{error:s}=await i.from("risk_alerts").update({acknowledged:!0,acknowledged_at:new Date().toISOString()}).eq("id",r).eq("user_id",e);if(s)return console.error("Error acknowledging alert:",s),{success:!1,error:"Failed to acknowledge alert"};return{success:!0,message:"Alert acknowledged successfully"}}catch(e){return console.error("Error acknowledging alert:",e),{success:!1,error:"Internal server error"}}}async function R(e,t){let r=m(),{data:i}=await r.from("kill_switch_events").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(1),s=i?.[0]?.event_type==="triggered",a=s?i[0].created_at:null,o=function(e){let t=[],r=!1;return e.dailyLoss>=e.riskLimits.maxDailyLoss&&(t.push({type:"daily_loss",current:e.dailyLoss,limit:e.riskLimits.maxDailyLoss,severity:"high"}),r=!0),e.consecutiveFailures>=e.riskLimits.maxConsecutiveFailures&&(t.push({type:"consecutive_failures",current:e.consecutiveFailures,limit:e.riskLimits.maxConsecutiveFailures,severity:"medium"}),r=!0),e.failureRate>=(e.riskLimits.maxFailureRate||30)&&(t.push({type:"high_failure_rate",current:e.failureRate,limit:e.riskLimits.maxFailureRate||30,severity:"medium"}),r=!0),{shouldTrigger:r,risks:t}}(t);return{isActive:!0,isTriggered:s,lastTriggered:a,autoTriggerRisk:o,status:s?"triggered":o.shouldTrigger?"warning":"normal"}}function S(){return{max_daily_loss:1e3,max_drawdown:15,max_consecutive_failures:5,max_failure_rate:30,max_portfolio_risk:20,max_sector_concentration:25,max_correlation:.8}}let q=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/risk/route",pathname:"/api/risk",filename:"route",bundlePath:"app/api/risk/route"},resolvedPagePath:"C:\\Users\\User1\\Downloads\\TradingBot\\apps\\frontend\\src\\app\\api\\risk\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:L,staticGenerationAsyncStorage:E,serverHooks:I,headerHooks:T,staticGenerationBailout:F}=q,D="/api/risk/route";function A(){return(0,o.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:E})}},3973:(e,t,r)=>{r.d(t,{qQ:()=>s});class i{store={};defaultLimit;defaultWindow;constructor(e=100,t=9e5){this.defaultLimit=e,this.defaultWindow=t,setInterval(()=>{this.cleanup()},3e5)}async check(e,t=this.defaultLimit,r=this.defaultWindow){let i=this.getIdentifier(e),s=Date.now(),a=`${i}:${Math.floor(s/r)}`;this.store[a]||(this.store[a]={count:0,resetTime:s+r});let o=this.store[a];return o.count>=t?{success:!1,remaining:0,resetTime:o.resetTime,error:`Rate limit exceeded. Try again in ${Math.ceil((o.resetTime-s)/1e3)} seconds.`}:(o.count++,{success:!0,remaining:t-o.count,resetTime:o.resetTime})}getIdentifier(e){let t=e.headers.get("x-user-id");if(t)return`user:${t}`;let r=e.headers.get("x-forwarded-for"),i=e.headers.get("x-real-ip"),s=r?r.split(",")[0]?.trim():i||"unknown";return`ip:${s}`}cleanup(){let e=Date.now();Object.keys(this.store).forEach(t=>{let r=this.store[t];r&&r.resetTime<e&&delete this.store[t]})}async checkLimit(e,t="default"){let r="action"===t?10:this.defaultLimit,i=await this.check(e,r);return i.success?{allowed:!0}:{allowed:!1,retryAfter:Math.ceil((i.resetTime-Date.now())/1e3)}}getStatus(e){let t=this.getIdentifier(e),r=Date.now(),i=`${t}:${Math.floor(r/this.defaultWindow)}`,s=this.store[i];return s?{count:s.count,remaining:Math.max(0,this.defaultLimit-s.count),resetTime:s.resetTime}:{count:0,remaining:this.defaultLimit,resetTime:r+this.defaultWindow}}}let s=new i;function a(e=100,t=9e5){return async r=>{let i=await s.check(r,e,t);return{...i,headers:{"X-RateLimit-Limit":e.toString(),"X-RateLimit-Remaining":i.remaining.toString(),"X-RateLimit-Reset":Math.ceil(i.resetTime/1e3).toString()}}}}a(5,9e5),a(100,9e5),a(50,6e4)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[308,294,437,991],()=>r(1826));module.exports=i})();